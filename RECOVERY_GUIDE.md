# org-supertag 数据库恢复指南

## 概述

这是一个完整的 org-supertag 数据库恢复套件，整合了所有恢复功能，能够处理各种数据丢失情况。

## 快速开始

### 1. 加载恢复套件

```elisp
M-x load-file RET org-supertag-recovery.el RET
```

### 2. 启动恢复

```elisp
M-x org-supertag-recovery-full-suite
```

或紧急恢复：

```elisp
M-x org-supertag-emergency-recovery
```

## 恢复功能模块

### 📊 诊断功能
- **功能**: 全面诊断数据库状态
- **检查内容**:
  - 数据库文件存在性和大小
  - 实体类型分布（节点、标签等）
  - metadata 完整性
  - 备份文件可用性

### 🗃️ 数据库级别恢复
- **从备份恢复**: 自动查找最新备份并恢复
- **重建数据库**: 从头重新扫描所有 org 文件
- **强制重新同步**: 清除同步状态后重新同步

### 🏷️ 标签定义恢复
- **智能分析**: 分析所有节点中的标签使用情况
- **自动创建**: 为所有使用的标签创建定义
- **统计信息**: 包含使用次数、源节点等元数据

### 🔗 字段定义恢复  
- **链接分析**: 从 node-field 链接关系推断字段定义
- **类型推断**: 自动推断字段类型（string、number、date、options等）
- **使用统计**: 记录字段使用频率和示例值

### 🔀 标签关系恢复
- **metadata 挖掘**: 从metadata中提取共现关系数据
- **PMI 计算**: 利用点互信息计算关系强度
- **关系网络**: 重建标签之间的cooccurrence关系

## 使用场景

### 场景 1: 标签全部丢失
```
症状: org-supertag-tag-add-tag 无法补全标签
解决: 选择菜单项 4 "从节点重建标签定义"
```

### 场景 2: 字段定义丢失
```
症状: 标签存在但字段定义为空
解决: 选择菜单项 5 "从链接恢复字段定义"
```

### 场景 3: 标签关系丢失
```
症状: 标签存在但没有关联关系
解决: 选择菜单项 6 "从metadata恢复标签关系"
```

### 场景 4: 数据库完全损坏
```
症状: 数据库无法加载或为空
解决: 选择菜单项 2 "从备份恢复" 或 3 "重建整个数据库"
```

### 场景 5: 完全重建
```
症状: 多种数据丢失
解决: 选择菜单项 7 "执行完整恢复流程"
```

## 恢复流程

### 完整恢复流程 (菜单项 7)

1. **诊断阶段**: 评估当前数据库状态
2. **标签重建**: 从节点数据恢复所有标签定义
3. **字段恢复**: 从链接关系恢复字段定义
4. **关系恢复**: 从metadata恢复标签关系
5. **最终验证**: 确认恢复结果

### 渐进式恢复流程

1. 运行 `org-supertag-recovery-diagnose` 了解问题
2. 根据诊断结果选择对应的恢复功能
3. 使用 `org-supertag-recovery-show-status` 查看恢复进度

## 安全保障

- ✅ **自动备份**: 恢复前自动备份当前数据库
- ✅ **无损操作**: 大部分操作只添加数据，不删除现有数据
- ✅ **错误处理**: 完善的错误处理和回滚机制
- ✅ **状态跟踪**: 详细的恢复状态和进度跟踪

## 恢复统计

恢复过程会跟踪以下统计信息：

- **标签恢复**: 新建和更新的标签数量
- **字段恢复**: 恢复的字段定义数量
- **关系恢复**: 重建的关系数量
- **数据完整性**: 实体和链接的最终数量

## 技术细节

### 恢复算法

1. **标签识别**: 通过正则表达式识别 `#tag` 格式
2. **字段类型推断**: 基于值模式推断字段类型
3. **关系强度计算**: 使用PMI值计算关系强度
4. **去重机制**: 避免重复创建相同的定义

### 数据来源

- **节点数据**: `:tags` 属性中的标签引用
- **链接数据**: `:node-field:` 前缀的字段链接
- **metadata**: `tag-cooccur:` 和 `tag-pmi:` 键值对

## 故障排除

### 常见问题

1. **"Invalid condition handler"错误**
   - 使用 `org-supertag-recovery.el` 而不是旧的脚本

2. **"未找到metadata记录"**
   - metadata 可能已丢失，使用节点数据恢复

3. **"没有发现字段使用记录"**
   - 字段链接可能已丢失，需要手动重建字段定义

### 日志和调试

- 所有操作都有详细的message输出
- 恢复状态保存在 `org-supertag-recovery--state` 中
- 使用诊断功能查看当前状态

## 最佳实践

1. **定期备份**: 确保有可用的数据库备份
2. **渐进恢复**: 从最小破坏的恢复开始
3. **验证结果**: 恢复后验证功能是否正常
4. **保留记录**: 保存恢复前的诊断信息

---

**注意**: 在执行任何恢复操作前，建议先运行诊断功能了解数据状态，并确保有数据备份。 